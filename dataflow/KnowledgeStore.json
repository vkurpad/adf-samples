{
	"name": "KnowledgeStore",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ObjectProjections",
						"type": "DatasetReference"
					},
					"name": "CogSearchProjections"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "DocumentsTable",
						"type": "DatasetReference"
					},
					"name": "DocumentSink"
				}
			],
			"transformations": [
				{
					"name": "FlattenPages"
				},
				{
					"name": "DocumentKey"
				},
				{
					"name": "AggregateDocs"
				},
				{
					"name": "SelectDocs"
				}
			],
			"script": "source(output(\n\t\tmetadata_storage_content_type as string,\n\t\tmetadata_storage_size as string,\n\t\tmetadata_storage_last_modified as string,\n\t\tmetadata_storage_content_md5 as string,\n\t\tmetadata_storage_name as string,\n\t\tmetadata_storage_path as string,\n\t\tmetadata_content_type as string,\n\t\tmetadata_language as string,\n\t\tmetadata_author as string,\n\t\tmetadata_title as string,\n\t\tmetadata_creation_date as string,\n\t\tmerged_content as string,\n\t\tpages as (Entities as (Entity as string, EntitySubType as string, EntityType as string, Url as string)[], keyPhrases as string[], Page as string)[],\n\t\tImages as (Images as (height as string, imgdata as (width as string, height as string, originalWidth as string, originalHeight as string, rotationFromOriginal as string, contentOffset as string, pageNumber as string, contentType as string), originalHeight as string, originalWidth as string, tags as (confidence as double, hint as string, name as string)[], text as string, width as string), layoutText as (language as string, text as string, lines as (boundingBox as (x as string, y as string)[], text as string)[], words as (boundingBox as (x as string, y as string)[], text as string)[]))[]\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false) ~> CogSearchProjections\nDocumentKey foldDown(unroll(pages),\n\tmapColumn(\n\t\tmetadata_storage_content_type,\n\t\tmetadata_storage_size,\n\t\tmetadata_storage_last_modified,\n\t\tmetadata_storage_content_md5,\n\t\tmetadata_storage_name,\n\t\tmetadata_storage_path,\n\t\tmetadata_content_type,\n\t\tmetadata_language,\n\t\tmetadata_author,\n\t\tmetadata_title,\n\t\tmetadata_creation_date,\n\t\tmerged_content,\n\t\tpages,\n\t\tImages,\n\t\tDocumentId = DocumentId\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> FlattenPages\nCogSearchProjections keyGenerate(output(DocumentId as long),\n\tstartAt: 1L) ~> DocumentKey\nFlattenPages aggregate(groupBy(DocumentId,\n\t\tmetadata_storage_content_type,\n\t\tmetadata_storage_size,\n\t\tmetadata_storage_last_modified,\n\t\tmetadata_storage_content_md5,\n\t\tmetadata_storage_name,\n\t\tmetadata_storage_path,\n\t\tmetadata_content_type,\n\t\tmetadata_language,\n\t\tmetadata_author,\n\t\tmetadata_title,\n\t\tmetadata_creation_date,\n\t\tmerged_content),\n\tresult = count()) ~> AggregateDocs\nAggregateDocs select(mapColumn(\n\t\tDocumentId,\n\t\tmetadata_storage_content_type,\n\t\tmetadata_storage_size,\n\t\tmetadata_storage_last_modified,\n\t\tmetadata_storage_content_md5,\n\t\tmetadata_storage_name,\n\t\tmetadata_storage_path,\n\t\tmetadata_content_type,\n\t\tmetadata_language,\n\t\tmetadata_author,\n\t\tmetadata_title,\n\t\tmetadata_creation_date,\n\t\tmerged_content,\n\t\tpage_count = result\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectDocs\nSelectDocs sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> DocumentSink"
		}
	}
}