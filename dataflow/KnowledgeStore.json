{
	"name": "KnowledgeStore",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ObjectProjections",
						"type": "DatasetReference"
					},
					"name": "CogSearchProjections"
				},
				{
					"dataset": {
						"referenceName": "AzureSynapseAnalyticsTable3",
						"type": "DatasetReference"
					},
					"name": "EntityLookup"
				},
				{
					"dataset": {
						"referenceName": "DocumentKeyPhrases",
						"type": "DatasetReference"
					},
					"name": "KeyPhraseLookup"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "DocumentsTable",
						"type": "DatasetReference"
					},
					"name": "DocumentSink"
				},
				{
					"dataset": {
						"referenceName": "DocPagesTable",
						"type": "DatasetReference"
					},
					"name": "DocPageSink"
				},
				{
					"dataset": {
						"referenceName": "DocEntities",
						"type": "DatasetReference"
					},
					"name": "EntitiesSink"
				},
				{
					"dataset": {
						"referenceName": "DocumentEntity",
						"type": "DatasetReference"
					},
					"name": "DocumentEntity"
				},
				{
					"dataset": {
						"referenceName": "DocumentEntity",
						"type": "DatasetReference"
					},
					"name": "sink1"
				},
				{
					"dataset": {
						"referenceName": "DocumentKeyPhrases",
						"type": "DatasetReference"
					},
					"name": "KEyPhrasesSink"
				},
				{
					"dataset": {
						"referenceName": "DocKeyPhrase",
						"type": "DatasetReference"
					},
					"name": "DocumentKeyPhraseRef"
				}
			],
			"transformations": [
				{
					"name": "DocumentKey"
				},
				{
					"name": "SelectDocs"
				},
				{
					"name": "FlattenPages"
				},
				{
					"name": "SelectPage"
				},
				{
					"name": "SurrogateKey1"
				},
				{
					"name": "Select1"
				},
				{
					"name": "Select2"
				},
				{
					"name": "Flatten1"
				},
				{
					"name": "EntityLookupMerge"
				},
				{
					"name": "ConditionalSplit1"
				},
				{
					"name": "EntityKey"
				},
				{
					"name": "Aggregate1"
				},
				{
					"name": "Select3"
				},
				{
					"name": "Select4"
				},
				{
					"name": "Select5"
				},
				{
					"name": "Flatten2"
				},
				{
					"name": "Select6"
				},
				{
					"name": "Aggregate2"
				},
				{
					"name": "KeyPhraseKey"
				},
				{
					"name": "Lookup1"
				},
				{
					"name": "ConditionalSplit2"
				},
				{
					"name": "Select7"
				},
				{
					"name": "Select8"
				}
			],
			"script": "source(output(\n\t\tmetadata_storage_content_type as string,\n\t\tmetadata_storage_size as string,\n\t\tmetadata_storage_last_modified as string,\n\t\tmetadata_storage_content_md5 as string,\n\t\tmetadata_storage_name as string,\n\t\tmetadata_storage_path as string,\n\t\tmetadata_content_type as string,\n\t\tmetadata_language as string,\n\t\tmetadata_author as string,\n\t\tmetadata_title as string,\n\t\tmetadata_creation_date as string,\n\t\tmerged_content as string,\n\t\tpages as (Entities as (Entity as string, EntitySubType as string, EntityType as string, Url as string)[], keyPhrases as string[], Page as string)[],\n\t\tImages as (Images as (height as string, imgdata as (width as string, height as string, originalWidth as string, originalHeight as string, rotationFromOriginal as string, contentOffset as string, pageNumber as string, contentType as string), originalHeight as string, originalWidth as string, tags as (confidence as double, hint as string, name as string)[], text as string, width as string), layoutText as (language as string, text as string, lines as (boundingBox as (x as string, y as string)[], text as string)[], words as (boundingBox as (x as string, y as string)[], text as string)[]))[]\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false) ~> CogSearchProjections\nsource(output(\n\t\tPageId as long,\n\t\tEntity as string,\n\t\tEntitySubType as string,\n\t\tEntityType as string,\n\t\tUrl as string,\n\t\tEntityId as long\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> EntityLookup\nsource(output(\n\t\tDocumentId as long,\n\t\tkeyPhrases as string,\n\t\tkpcount as long,\n\t\tKeyPhraseKey as long\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> KeyPhraseLookup\nCogSearchProjections keyGenerate(output(DocumentId as long),\n\tstartAt: 1L) ~> DocumentKey\nDocumentKey select(mapColumn(\n\t\tDocumentId,\n\t\tmetadata_storage_content_type,\n\t\tmetadata_storage_size,\n\t\tmetadata_storage_last_modified,\n\t\tmetadata_storage_content_md5,\n\t\tmetadata_storage_name,\n\t\tmetadata_storage_path,\n\t\tmetadata_content_type,\n\t\tmetadata_language,\n\t\tmetadata_author,\n\t\tmetadata_title,\n\t\tmetadata_creation_date,\n\t\tmerged_content\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectDocs\nDocumentKey foldDown(unroll(pages),\n\tmapColumn(\n\t\tmetadata_storage_name,\n\t\tDocumentId,\n\t\tpages,\n\t\tPageContent = pages.Page\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> FlattenPages\nFlattenPages select(mapColumn(\n\t\tDocumentId,\n\t\tmetadata_storage_name,\n\t\tPage = pages.Page,\n\t\tpages\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectPage\nSelectPage keyGenerate(output(DocPageId as long),\n\tstartAt: 1L) ~> SurrogateKey1\nSurrogateKey1 select(mapColumn(\n\t\tDocumentId,\n\t\tDocPageId,\n\t\tpages,\n\t\tPage = Page\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nSurrogateKey1 select(mapColumn(\n\t\tmetadata_storage_name,\n\t\tDocumentId,\n\t\tPage,\n\t\tDocPageId\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select2\nSelect1 foldDown(unroll(pages.Entities),\n\tmapColumn(\n\t\tDocumentId,\n\t\tDocPageId,\n\t\teach(pages.Entities, match(true()))\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> Flatten1\nAggregate1, EntityLookup lookup(Aggregate1@Entity == EntityLookup@Entity\n\t&& Aggregate1@EntitySubType == EntityLookup@EntitySubType\n\t&& Aggregate1@EntityType == EntityLookup@EntityType,\n\tmultiple: false,\n\tpickup: 'first',\n\tasc(EntityLookup@Entity, true),\n\tbroadcast: 'auto')~> EntityLookupMerge\nEntityLookupMerge split(isNull(EntityId) ||  EntityId == 0,\n\tdisjoint: false) ~> ConditionalSplit1@(NewEntities, ExistingEntities)\nSelect3 keyGenerate(output(EntityKey as long),\n\tstartAt: 1L) ~> EntityKey\nFlatten1 aggregate(groupBy(DocumentId,\n\t\tEntity,\n\t\tEntitySubType,\n\t\tEntityType,\n\t\tUrl),\n\tentCount = count()) ~> Aggregate1\nConditionalSplit1@NewEntities select(mapColumn(\n\t\tDocumentId,\n\t\tEntity = ConditionalSplit1@NewEntities@Entity,\n\t\tEntitySubType = ConditionalSplit1@NewEntities@EntitySubType,\n\t\tEntityType = ConditionalSplit1@NewEntities@EntityType,\n\t\tUrl = ConditionalSplit1@NewEntities@Url,\n\t\tentCount,\n\t\tPageId\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select3\nEntityKey select(mapColumn(\n\t\tDocumentId,\n\t\tEntityId = EntityKey\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select4\nConditionalSplit1@ExistingEntities select(mapColumn(\n\t\tDocumentId,\n\t\tEntityId\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select5\nSelect6 foldDown(unroll(pages.keyPhrases),\n\tmapColumn(\n\t\tDocumentId,\n\t\tmetadata_storage_name,\n\t\tkeyPhrases = pages.keyPhrases\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Flatten2\nSurrogateKey1 select(mapColumn(\n\t\tDocumentId,\n\t\tmetadata_storage_name,\n\t\tpages,\n\t\tPageContent = pages.Page\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select6\nFlatten2 aggregate(groupBy(DocumentId,\n\t\tkeyPhrases),\n\tkpcount = count()) ~> Aggregate2\nSelect7 keyGenerate(output(KeyPhraseKey as long),\n\tstartAt: 1L) ~> KeyPhraseKey\nAggregate2, KeyPhraseLookup lookup(Aggregate2@keyPhrases == KeyPhraseLookup@keyPhrases,\n\tmultiple: false,\n\tpickup: 'first',\n\tasc(KeyPhraseLookup@keyPhrases, true),\n\tbroadcast: 'auto')~> Lookup1\nLookup1 split(isNull(KeyPhraseKey),\n\tdisjoint: false) ~> ConditionalSplit2@(NewKeyPhrases, ExistingKeyPhrases)\nConditionalSplit2@NewKeyPhrases select(mapColumn(\n\t\tDocumentId = ConditionalSplit2@NewKeyPhrases@DocumentId,\n\t\tkeyPhrases = ConditionalSplit2@NewKeyPhrases@keyPhrases\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select7\nKeyPhraseKey select(mapColumn(\n\t\tDocumentId,\n\t\tKeyPhraseKey\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select8\nSelectDocs sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> DocumentSink\nSelect2 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> DocPageSink\nEntityKey sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> EntitiesSink\nSelect4 sink(input(\n\t\tDocumentId as long,\n\t\tEntityId as long\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> DocumentEntity\nSelect5 sink(input(\n\t\tDocumentId as long,\n\t\tEntityId as long\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> sink1\nKeyPhraseKey sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> KEyPhrasesSink\nSelect8 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> DocumentKeyPhraseRef"
		}
	}
}