{
	"name": "KnowledgeStore",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ObjectProjections",
						"type": "DatasetReference"
					},
					"name": "CogSearchProjections"
				},
				{
					"dataset": {
						"referenceName": "AzureSynapseAnalyticsTable3",
						"type": "DatasetReference"
					},
					"name": "EntityLookup"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "DocumentsTable",
						"type": "DatasetReference"
					},
					"name": "DocumentSink"
				},
				{
					"dataset": {
						"referenceName": "DocPagesTable",
						"type": "DatasetReference"
					},
					"name": "DocPageSink"
				},
				{
					"dataset": {
						"referenceName": "DocEntities",
						"type": "DatasetReference"
					},
					"name": "EntitiesSink"
				}
			],
			"transformations": [
				{
					"name": "DocumentKey"
				},
				{
					"name": "SelectDocs"
				},
				{
					"name": "FlattenPages"
				},
				{
					"name": "SelectPage"
				},
				{
					"name": "SurrogateKey1"
				},
				{
					"name": "Select1"
				},
				{
					"name": "Select2"
				},
				{
					"name": "Flatten1"
				},
				{
					"name": "EntityLookupMerge"
				},
				{
					"name": "ConditionalSplit1"
				},
				{
					"name": "SurrogateKey2"
				},
				{
					"name": "DedupEntities"
				}
			],
			"script": "source(output(\n\t\tmetadata_storage_content_type as string,\n\t\tmetadata_storage_size as string,\n\t\tmetadata_storage_last_modified as string,\n\t\tmetadata_storage_content_md5 as string,\n\t\tmetadata_storage_name as string,\n\t\tmetadata_storage_path as string,\n\t\tmetadata_content_type as string,\n\t\tmetadata_language as string,\n\t\tmetadata_author as string,\n\t\tmetadata_title as string,\n\t\tmetadata_creation_date as string,\n\t\tmerged_content as string,\n\t\tpages as (Entities as (Entity as string, EntitySubType as string, EntityType as string, Url as string)[], keyPhrases as string[], Page as string)[],\n\t\tImages as (Images as (height as string, imgdata as (width as string, height as string, originalWidth as string, originalHeight as string, rotationFromOriginal as string, contentOffset as string, pageNumber as string, contentType as string), originalHeight as string, originalWidth as string, tags as (confidence as double, hint as string, name as string)[], text as string, width as string), layoutText as (language as string, text as string, lines as (boundingBox as (x as string, y as string)[], text as string)[], words as (boundingBox as (x as string, y as string)[], text as string)[]))[]\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false) ~> CogSearchProjections\nsource(output(\n\t\tPageId as long,\n\t\tEntity as string,\n\t\tEntitySubType as string,\n\t\tEntityType as string,\n\t\tUrl as string,\n\t\tEntityId as long\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> EntityLookup\nCogSearchProjections keyGenerate(output(DocumentId as long),\n\tstartAt: 1L) ~> DocumentKey\nDocumentKey select(mapColumn(\n\t\tDocumentId,\n\t\tmetadata_storage_content_type,\n\t\tmetadata_storage_size,\n\t\tmetadata_storage_last_modified,\n\t\tmetadata_storage_content_md5,\n\t\tmetadata_storage_name,\n\t\tmetadata_storage_path,\n\t\tmetadata_content_type,\n\t\tmetadata_language,\n\t\tmetadata_author,\n\t\tmetadata_title,\n\t\tmetadata_creation_date,\n\t\tmerged_content\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectDocs\nDocumentKey foldDown(unroll(pages),\n\tmapColumn(\n\t\tmetadata_storage_name = metadata_storage_name,\n\t\tDocumentId,\n\t\tPageContent = pages.Page,\n\t\tpages = pages\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> FlattenPages\nFlattenPages select(mapColumn(\n\t\tmetadata_storage_name = {},\n\t\tDocumentId,\n\t\tPage = PageContent,\n\t\tpages = pages\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectPage\nSelectPage keyGenerate(output(DocPageId as long),\n\tstartAt: 1L) ~> SurrogateKey1\nSurrogateKey1 select(mapColumn(\n\t\tDocumentId,\n\t\tDocPageId,\n\t\tpages = pages\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nSurrogateKey1 select(mapColumn(\n\t\tmetadata_storage_name,\n\t\tDocumentId,\n\t\tPage,\n\t\tDocPageId\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select2\nSelect1 foldDown(unroll(pages.Entities),\n\tmapColumn(\n\t\tDocumentId,\n\t\tDocPageId,\n\t\teach(pages.Entities, match(true()))\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> Flatten1\nDedupEntities, EntityLookup lookup(Flatten1@Entity == EntityLookup@Entity\n\t&& Flatten1@EntityType == EntityLookup@EntityType,\n\tmultiple: false,\n\tpickup: 'first',\n\tasc(EntityLookup@Entity, true),\n\tbroadcast: 'auto')~> EntityLookupMerge\nEntityLookupMerge split(isNull(EntityId) ||  EntityId == 0,\n\tdisjoint: false) ~> ConditionalSplit1@(NewEntities, ExistingEntities)\nConditionalSplit1@NewEntities keyGenerate(output(DocEntityId as long),\n\tstartAt: 1L) ~> SurrogateKey2\nFlatten1 aggregate(groupBy(Entity,\n\t\tEntitySubType,\n\t\tEntityType,\n\t\tUrl),\n\tcount = count()) ~> DedupEntities\nSelectDocs sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> DocumentSink\nSelect2 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> DocPageSink\nSurrogateKey2 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> EntitiesSink"
		}
	}
}